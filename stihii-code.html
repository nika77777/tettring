<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Калькулятор кода и имени печати — 7 Врат (Глиф-Маяк и Стихии)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: sans-serif; max-width: 980px; margin: auto; padding: 20px; }
  select, button, input { font-size: 1em; margin: 6px 0; padding: 6px; }
  .label { font-weight: 700; margin-top: 12px; }
  .row { margin: 10px 0 16px; padding: 10px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; }
  .row-title { font-size: 1.02em; }
  .result { margin-top: 16px; font-weight: 700; font-size: 1.1em; }
  .mono { font-family: ui-monospace, Menlo, Consolas, monospace; line-height: 1.7; }
  .muted { color: #555; font-size: 0.95em; }
  .syll { display: inline-block; margin-right: 10px; }
  .pick { font-weight: 700; background: #fff3c4; border-radius: 4px; padding: 1px 4px; }
  .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
  .toast { font-size: 0.95em; color: #2c6e2f; display: none; }
  .toast.show { display: inline; }
  .error { color:#b00020; margin-top: 6px; }
  table { border-collapse: collapse; width: 100%; margin-top: 14px; }
  th, td { border: 1px solid #e6e6e6; padding: 8px 10px; text-align: left; vertical-align: top; }
  th { background: #f7f7f7; font-weight: 700; }
  .particles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; margin-top: 10px; }
  .card { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fff; }
  .card img { width: 100%; height: auto; border-radius: 8px; display: block; }
  .card .title { font-weight: 700; margin-top: 8px; }
  .card .desc { color: #444; font-size: 0.95em; margin-top: 6px; white-space: pre-line; }
  .card .note { color: #777; font-size: 0.9em; margin-top: 6px; }
  .inline { display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; }
</style>
</head>
<body>
<h2>Калькулятор кода и имени печати — 7 Врат (Глиф-Маяк и Стихии)</h2>

<div id="selectors"></div>

<div class="btn-row inline">
  <button onclick="calculateAll()">Рассчитать код и имя</button>
  <label for="participantName" class="muted">Имя участника:</label>
  <input id="participantName" type="text" placeholder="Введите имя" style="min-width: 220px;">
  <button id="copyResultsBtn"  onclick="copyResults()"        disabled>Скопировать результаты</button>
  <button id="downloadTxtBtn"  onclick="downloadResultsTxt()" disabled>Скачать .txt</button>
  <span id="copyToast" class="toast">Скопировано</span>
  <span id="downloadToast" class="toast">Скачано</span>
</div>

<div id="dupWarn" class="error"></div>

<div class="label">Сводная таблица по вратам</div>
<div id="gatesTable"></div>

<div class="result" id="codeOut"></div>
<div class="result" id="nameOut"></div>

<div class="label">Исходная строка слогов:</div>
<div id="srcSyllables" class="mono"></div>

<div class="label">Рабочая строка:</div>
<div id="workDesc" class="muted"></div>
<div id="workSyllables" class="mono"></div>
<div id="pickInfo" class="muted"></div>

<div class="label">Тэттрачастицы имени:</div>
<div id="particlesOut" class="particles-grid"></div>
<div id="particlesErr" class="muted error"></div>

<script>
/* particles.json */
let particlesMap = {};
fetch("particles.json")
  .then(r => { if (!r.ok) throw new Error(); return r.json(); })
  .then(d => { particlesMap = d; })
  .catch(() => { particlesMap = {}; document.getElementById("particlesErr").textContent = "Не удалось загрузить particles.json."; });

/* тэттраглифы */
const glyphs = [
  ["Эль Аталар", 1, ["Ата","Лар"]],
  ["Эль Ви-Шах", 2, ["Ви","Шах"]],
  ["Эль Нере-Ар", 3, ["Нере","Ар"]],
  ["Эль Ви-Нар", 4, ["Ви","Нар"]],
  ["Эль Эн-Инь-О", 5, ["Эн","Инь","О"]],
  ["Эль Ра-Дам", 6, ["Ра","Дам"]],
  ["Эль Муд-Рам", 7, ["Муд","Рам"]],
  ["Эль Мун-Ио", 8, ["Мун","Ио"]],
  ["Эль Мар-Кам", 9, ["Мар","Кам"]],
  ["Эль Рэ-Тан", 10, ["Рэ","Тан"]],
  ["Эль Ке-Тар", 11, ["Ке","Тар"]],
  ["Эль Ок-Улос", 12, ["Ок","Улос"]],
  ["Эль Мана-Рат", 13, ["Мана","Рат"]],
  ["Эль Хот-Та", 14, ["Хот","Та"]],
  ["Эль Ле-Дар", 15, ["Ле","Дар"]],
  ["Эль Аму", 16, ["Эль","Аму"]],
  ["Эль Прай-Я", 17, ["Прай","Я"]],
  ["Эль Кар", 18, ["Эль","Кар"]],
  ["Эль Ошта-Лар", 19, ["Ошта","Лар"]],
  ["Эль Су-Ни-Я", 20, ["Су","Ни","Я"]],
  ["Эль Ра", 21, ["Эль","Ра"]],
];
const codeToGlyphName = new Map(glyphs.map(([n,c])=>[c,n]));
const codeToSyllables = new Map(glyphs.map(([n,c,s])=>[c,s]));

/* имена врат (Врата №X — жирным, имя — обычным) */
const GATE_NAMES = [
  "Глиф-Маяк",
  "Земля (Энергетический уровень: Зерно-Род; Сознательный уровень: Замысел)",
  "Огонь (Энергетический уровень: Вдохновение; Сознательный уровень: Воля)",
  "Плазма (Энергетический уровень: Любовь; Сознательный уровень: Магия)",
  "Воздух (Энергетический уровень: Обмен; Сознательный уровень: Промысел)",
  "Вода (Энергетический уровень: Поток; Сознательный уровень: Сценарий)",
  "Пустотность (Энергетический уровень: Тайна; Сознательный уровень: Автор)"
];

function renderSelectors(){
  const c=document.getElementById("selectors"); c.innerHTML="";
  for(let i=0;i<GATE_NAMES.length;i++){
    const row=document.createElement("div"); row.className="row";
    const title=document.createElement("div"); title.className="row-title";
    title.innerHTML = `<b>Врата №${i}</b>: ${GATE_NAMES[i]}`;
    const sel=document.createElement("select"); sel.id=`gate-${i}`;
    const ph=document.createElement("option"); ph.value=""; ph.textContent="— выберите тэттраглиф —"; ph.disabled=true; ph.selected=true; sel.appendChild(ph);
    glyphs.forEach(([name,code])=>{ const opt=document.createElement("option"); opt.value=code; opt.textContent=`${name} (${code})`; sel.appendChild(opt); });
    row.appendChild(title); row.appendChild(sel); c.appendChild(row);
  }
  attachGateHandlers();
}

/* расчёты */
function reduceCode(sum){ while(sum>10) sum=sum.toString().split("").reduce((a,b)=>a+Number(b),0); if(sum===1) sum=10; return sum; }
function getSourceSyllables(codes){ const out=[]; codes.forEach(c=>{ const s=codeToSyllables.get(c); if(s) out.push(...s); }); return out; }
function pickEveryNthSyllable(n, src){
  const L=src.length; let work=src.slice(), extended=false;
  if(Math.floor(L/n)<2){ work=src.concat(src); extended=true; }
  const picked=[], positions=[];
  for(let k=1;k<=n;k++){ const pos=n*k; if(pos<=work.length){ picked.push(work[pos-1]); positions.push(pos);} else break; }
  return {picked,positions,work,extended};
}
function postprocessName(p){
  const L=p.length; if(!L) return p; if(L===2&&p[0]===p[1]) return p;
  if(L===3){ if(p[0]===p[1]&&p[1]!==p[2]) return [p[0],p[2],p[1]]; if(p[1]===p[2]&&p[0]!==p[1]) return [p[1],p[0],p[2]]; return p; }
  const seen=new Set(), u=[]; p.forEach(s=>{ if(!seen.has(s)){seen.add(s); u.push(s);} }); return u.length>=2?u:p;
}

/* визуализация */
function renderSyllableLine(id, arr, picks){
  document.getElementById(id).innerHTML=arr.map((s,i)=>{
    const idx=i+1, cls=picks.includes(idx)?'syll pick':'syll';
    return `<span class="${cls}">${idx}.${s}</span>`;
  }).join("  ");
}
function renderGatesTable(codes){
  const rows=codes.map((code,i)=>{
    const name=code?(codeToGlyphName.get(code)||"—"):"—";
    const syll=code?(codeToSyllables.get(code)||[]).join(", "):"—";
    return `<tr>
      <td><b>Врата №${i}</b>: ${GATE_NAMES[i]}</td>
      <td>${name}</td>
      <td>${syll}</td>
    </tr>`;
  }).join("");
  document.getElementById("gatesTable").innerHTML=
    `<table><thead><tr><th>Врата</th><th>Тэттраглиф</th><th>Слоги</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function renderParticlesCards(syllables){
  const box=document.getElementById("particlesOut"), err=document.getElementById("particlesErr"); err.textContent="";
  if(!syllables||!syllables.length){ box.innerHTML=""; return; }
  box.innerHTML=syllables.map(s=>{
    const p=particlesMap[s];
    return p
      ? `<div class="card">${p.img?`<img src="${p.img}" alt="${p.title||s}" loading="lazy">`:""}<div class="title">${p.title||s}</div><div class="desc">${p.desc||""}</div></div>`
      : `<div class="card"><div class="title">${s}</div><div class="note">Нет данных</div></div>`;
  }).join("");
}

/* уведомления */
function showToast(id){ const t=document.getElementById(id); t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1300); }

/* сбор полезной нагрузки (имя + TSV + частицы) */
function buildResultsPayload() {
  const nameText = document.getElementById("nameOut").textContent.trim();
  if (!nameText || nameText === "Имя печати: —") return null;

  const rows = [...document.querySelectorAll("#gatesTable tbody tr")].map(tr =>
    [...tr.querySelectorAll("td")].map(td => td.textContent.trim())
  );
  const header = ["Врата","Тэттраглиф","Слоги"];
  const tsv = [header, ...rows].map(r => r.join("\t")).join("\n");

  const syllables = nameText.replace("Имя печати: ","").split(/\s+/).filter(Boolean);
  const particlesLines = syllables.map(s => {
    const d = particlesMap[s];
    const desc = d?.desc ? d.desc.trim() : "(нет описания)";
    return `${s} → ${desc}`;
  }).join("\n");

  return { nameText, tsv, particlesLines, syllables };
}

/* копирование результатов (имя + TSV + частицы) */
function copyResults(){
  const p = buildResultsPayload(); if (!p) return;
  const full = `${p.nameText}\n\n${p.tsv}\n\n${p.particlesLines}`;
  navigator.clipboard.writeText(full).then(()=>showToast("copyToast"));
}

/* скачивание .txt (имя файла = <участник>-<имя_печати>.txt) */
function downloadResultsTxt(){
  const p = buildResultsPayload(); if (!p) return;

  const participantRaw = (document.getElementById("participantName").value || "").trim() || "участник";
  // безопасное имя файла: разрешаем латиницу, кириллицу, цифры, _, -, заменяем остальное на _
  const safe = s => s
    .replace(/\s+/g, "_")
    .replace(/[^A-Za-z0-9_\-\u0400-\u04FF]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "");

  const sealName = p.nameText.replace("Имя печати: ","").trim() || "печать";
  const fileName = `${safe(participantRaw)}-${safe(sealName)}.txt`;

  const content = `${p.nameText}\nУчастник: ${participantRaw}\n\n${p.tsv}\n\n${p.particlesLines}\n`;
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url; a.download = fileName;
  document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
  showToast("downloadToast"); // показываем «Скачано»
}

/* анти-дубликат */
function getSelectedCodes(){ return Array.from(document.querySelectorAll("#selectors select")).map(s=>s.value).filter(v=>v!==""); }
function updateOptionLocks(){
  const selected=getSelectedCodes();
  document.querySelectorAll("#selectors select").forEach(sel=>{
    const current=sel.value;
    Array.from(sel.options).forEach(opt=>{
      if(opt.value===""){ opt.disabled=true; return; }
      opt.disabled = selected.includes(opt.value) && opt.value!==current;
    });
  });
}
function attachGateHandlers(){
  document.querySelectorAll("#selectors select").forEach(sel=>{
    sel.addEventListener("change", ()=>{ document.getElementById("dupWarn").textContent=""; updateOptionLocks(); });
  });
  updateOptionLocks();
}

/* расчёт */
function calculateAll(){
  const selects=GATE_NAMES.map((_,i)=>document.getElementById(`gate-${i}`));
  const codes=[]; let incomplete=false;
  for(const sel of selects){ const v=parseInt(sel.value,10); if(isNaN(v)){ incomplete=true; codes.push(null);} else { codes.push(v);} }

  // таблица — всегда по текущему состоянию
  renderGatesTable(codes);

  // проверка дубликатов
  const dupWarn=document.getElementById("dupWarn"); dupWarn.textContent="";
  const counts=new Map(); let hasDup=false;
  codes.forEach(c=>{ if(c==null) return; const k=String(c); counts.set(k,(counts.get(k)||0)+1); });
  for(const [,cnt] of counts){ if(cnt>1){ hasDup=true; break; } }

  // отключение вывода при ошибках
  const disableOutputs=(msg)=>{
    document.getElementById("codeOut").textContent="";
    document.getElementById("nameOut").textContent="";
    document.getElementById("srcSyllables").innerHTML="";
    document.getElementById("workSyllables").innerHTML="";
    document.getElementById("workDesc").textContent="";
    document.getElementById("pickInfo").textContent=msg||"";
    document.getElementById("particlesOut").innerHTML="";
    document.getElementById("copyResultsBtn").disabled=true;
    document.getElementById("downloadTxtBtn").disabled=true;
  };

  if(hasDup){ dupWarn.textContent="Нельзя выбирать одинаковые тэттраглифы для разных врат."; disableOutputs("Обнаружены дубликаты выбора."); return; }
  if(incomplete){ disableOutputs("Пожалуйста, выберите тэттраглиф для всех 7 врат."); return; }

  // расчёт
  const sum=codes.reduce((a,b)=>a+(b||0),0), n=reduceCode(sum);
  const src=getSourceSyllables(codes); renderSyllableLine("srcSyllables", src, []);
  const {picked,positions,work,extended}=pickEveryNthSyllable(n,src);
  const finalNameParts=postprocessName(picked);

  document.getElementById("codeOut").textContent=`Финальный числовой код: ${n}`;
  document.getElementById("workDesc").textContent=extended?"Рабочая строка удлинена":"Рабочая строка (удлинение не потребовалось)";
  renderSyllableLine("workSyllables", work, positions);

  let info=positions.length
    ? `Выбранные позиции: ${positions.join(", ")} (каждый ${n}-й слог). `
    : `Нет доступных позиций, кратных ${n}, в рабочей строке. `;
  if(positions.length>=2) info+="Выбор слогов завершён: набрано два или более слогов, как предусмотрено в правилах формирования имени печати.";
  document.getElementById("pickInfo").textContent=info;

  const finalName=finalNameParts.join(" ")||"—";
  document.getElementById("nameOut").textContent=`Имя печати: ${finalName}`;

  const canCopy = finalName !== "—";
  document.getElementById("copyResultsBtn").disabled  = !canCopy;
  document.getElementById("downloadTxtBtn").disabled  = !canCopy;

  renderParticlesCards(finalNameParts);
}

renderSelectors();
</script>
</body>
</html>
