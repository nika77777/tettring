<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор кода и имени печати</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: sans-serif; max-width: 980px; margin: auto; padding: 20px; }
    select, button, input { font-size: 1em; margin: 6px 0; padding: 6px; }
    .label { font-weight: 700; margin-top: 14px; }
    .row { margin: 10px 0 16px; padding: 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; }
    .row-title { font-size: 1.02em; font-weight: 700; }
    .row-desc { color: #555; font-size: 0.95em; margin-top: 6px; }
    .result { margin-top: 16px; font-weight: 700; font-size: 1.1em; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; line-height: 1.7; }
    .muted { color: #555; font-size: 0.95em; }
    .syll { display: inline-block; margin-right: 10px; }
    .pick { font-weight: 700; background: #fff3c4; border-radius: 4px; padding: 1px 4px; }
    .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
    .toast { font-size: 0.95em; color: #2c6e2f; display: none; }
    .toast.show { display: inline; }
    .error { color:#b00020; margin-top: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #e6e6e6; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; font-weight: 700; }
    .inline { display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  </style>
</head>

<body>

<h2>Калькулятор кода и имени печати</h2>
<div class="muted" style="margin-top:-6px;">
  Выберите по одному тэттраглифу для каждого врата (минимум 3).
  Финальный числовой код рассчитывается как свёртка суммы кодов,
  после чего имя печати формируется через выбор каждого <span class="mono">n</span>-го слога.
</div>

<div class="btn-row inline">
  <label for="numMirrors" class="muted">Количество врат:</label>
  <input id="numMirrors" type="number" min="3" max="60" value="3" style="width:110px;">
  <button onclick="renderSelectors()">Применить</button>
</div>

<div id="selectors"></div>

<div class="btn-row inline">
  <button onclick="calculateAll()">Рассчитать код и имя</button>

  <label for="participantName" class="muted">Имя участника:</label>
  <input id="participantName" type="text" placeholder="Введите имя" style="min-width:220px;">

  <button id="downloadTxtBtn" onclick="downloadResultsTxt()" disabled>Скачать .txt</button>
  <span id="downloadToast" class="toast">Скачано</span>
</div>

<div id="dupWarn" class="error"></div>

<div class="label">Сводная таблица по вратам</div>
<div id="gatesTable"></div>

<div class="result" id="codeOut"></div>
<div id="codeExplain" class="muted"></div>

<div class="result" id="nameOut"></div>

<div class="label">Исходная строка слогов:</div>
<div id="srcSyllables" class="mono"></div>

<div class="label">Рабочая строка:</div>
<div id="workDesc" class="muted"></div>
<div id="workSyllables" class="mono"></div>
<div id="pickInfo" class="muted"></div>

<script>
/* =========================
   DATA
   ========================= */

const glyphs = [
  ["Эль Аталар",1,["Ата","Лар"]],
  ["Эль Ви-Шах",2,["Ви","Шах"]],
  ["Эль Нере-Ар",3,["Нере","Ар"]],
  ["Эль Ви-Нар",4,["Ви","Нар"]],
  ["Эль Эн-Инь-О",5,["Эн","Инь","О"]],
  ["Эль Ра-Дам",6,["Ра","Дам"]],
  ["Эль Муд-Рам",7,["Муд","Рам"]],
  ["Эль Мун-Ио",8,["Мун","Ио"]],
  ["Эль Мар-Кам",9,["Мар","Кам"]],
  ["Эль Рэ-Тан",10,["Рэ","Тан"]],
  ["Эль Ке-Тар",11,["Ке","Тар"]],
  ["Эль Ок-Улос",12,["Ок","Улос"]],
  ["Эль Мана-Рат",13,["Мана","Рат"]],
  ["Эль Хот-Та",14,["Хот","Та"]],
  ["Эль Ле-Дар",15,["Ле","Дар"]],
  ["Эль Аму",16,["Эль","Аму"]],
  ["Эль Прай-Я",17,["Прай","Я"]],
  ["Эль Кар",18,["Эль","Кар"]],
  ["Эль Ошта-Лар",19,["Ошта","Лар"]],
  ["Эль Су-Ни-Я",20,["Су","Ни","Я"]],
  ["Эль Ра",21,["Эль","Ра"]],
];

const codeToGlyphName = new Map(glyphs.map(([n,c])=>[c,n]));
const codeToSyllables = new Map(glyphs.map(([n,c,s])=>[c,s]));

/* =========================
   RENDER SELECTORS (cards)
   ========================= */

function clampMirrors(v){
  v = Number(v);
  return Math.max(3, Math.min(60, Math.floor(v || 3)));
}

function renderSelectors(){
  const total = clampMirrors(numMirrors.value);
  numMirrors.value = total;

  const box = document.getElementById("selectors");
  box.innerHTML = "";

  for(let i=0;i<total;i++){
    const row = document.createElement("div");
    row.className = "row";

    const title = document.createElement("div");
    title.className = "row-title";
    title.textContent = `Врата №${i+1}`;

    const desc = document.createElement("div");
    desc.className = "row-desc";
    desc.textContent = `Выберите тэттраглиф для врат №${i+1}.`;

    const sel = document.createElement("select");
    sel.id = `gate-${i}`;

    const ph = new Option("— выберите тэттраглиф —","",true,true);
    ph.disabled = true;
    sel.add(ph);

    glyphs.forEach(([name,code])=>{
      sel.add(new Option(`${name} (${code})`,code));
    });

    row.append(title,desc,sel);
    box.appendChild(row);
  }

  attachGateHandlers();
  renderGatesTable(Array(total).fill(null));
  resetOutputs("Выберите тэттраглифы и нажмите «Рассчитать код и имя».");
}

/* =========================
   HELPERS
   ========================= */

function reduceCode(sum){
  while(sum>10){
    sum = sum.toString().split("").map(Number).reduce((a,b)=>a+b,0);
  }
  if(sum===1) sum=10;
  return sum;
}

function explainReduction(sum){
  const steps=[];
  let cur=sum;
  while(cur>10){
    const d=cur.toString().split("").map(Number);
    steps.push(`${cur} → ${d.join(" + ")} = ${d.reduce((a,b)=>a+b,0)}`);
    cur=d.reduce((a,b)=>a+b,0);
  }
  if(cur===1){
    steps.push("1 → 10 (по принятому правилу)");
  }
  return steps;
}

function attachGateHandlers(){
  document.querySelectorAll("#selectors select").forEach(sel=>{
    sel.onchange=updateOptionLocks;
  });
  updateOptionLocks();
}

function updateOptionLocks(){
  const selected=[...document.querySelectorAll("#selectors select")]
    .map(s=>s.value).filter(Boolean);
  document.querySelectorAll("#selectors select").forEach(sel=>{
    [...sel.options].forEach(o=>{
      if(!o.value) return;
      o.disabled = selected.includes(o.value) && o.value!==sel.value;
    });
  });
}

function getSourceSyllables(codes){
  return codes.flatMap(c=>codeToSyllables.get(c)||[]);
}

function renderSyllableLine(id,arr,picks){
  document.getElementById(id).innerHTML=arr.map((s,i)=>{
    const n=i+1;
    return `<span class="syll ${picks.includes(n)?"pick":""}">${n}.${s}</span>`;
  }).join(" ");
}

/* =========================
   BUGFIX: extend until >= n and 2n
   ========================= */

function pickEveryNthSyllable(n,src){
  let work=[...src], repeats=0;
  while(Math.floor(work.length/n)<2 && repeats<50){
    work=work.concat(src);
    repeats++;
  }
  const picked=[],pos=[];
  for(let k=1;;k++){
    const p=n*k;
    if(p<=work.length){
      picked.push(work[p-1]);
      pos.push(p);
    } else break;
  }
  return {picked,pos,work,repeats};
}

/* =========================
   TABLE
   ========================= */

function renderGatesTable(codes){
  const rows=codes.map((c,i)=>`
    <tr>
      <td><b>Врата №${i+1}</b></td>
      <td>${c?codeToGlyphName.get(c):"—"}</td>
      <td>${c?(codeToSyllables.get(c)||[]).join(", "):"—"}</td>
    </tr>`).join("");

  gatesTable.innerHTML=`
    <table>
      <thead><tr><th>Врата</th><th>Тэттраглиф</th><th>Слоги</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* =========================
   TXT EXPORT
   ========================= */

function downloadResultsTxt(){
  const name=nameOut.textContent.replace("Имя печати:","").trim();
  if(!name||name==="—") return;

  const participant=participantName.value.trim()||"участник";
  const safe=s=>s.replace(/\s+/g,"_").replace(/[^\w\u0400-\u04FF-]/g,"_");

  const rows=[...document.querySelectorAll("#gatesTable tbody tr")]
    .map(tr=>[...tr.children].map(td=>td.textContent).join("\t")).join("\n");

  const text=`Практик: ${participant}
Имя печати: ${name}

Врата\tТэттраглиф\tСлоги
${rows}
`;

  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${safe(participant)}-${safe(name)}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast("downloadToast");
}

/* =========================
   MAIN
   ========================= */

function calculateAll(){
  const selects=[...document.querySelectorAll("#selectors select")];
  const codes=[];
  for(const s of selects){
    if(!s.value){ resetOutputs("Выберите тэттраглифы для всех врат."); return; }
    codes.push(+s.value);
  }

  renderGatesTable(codes);

  const sum=codes.reduce((a,b)=>a+b,0);
  const n=reduceCode(sum);

  codeOut.textContent=`Финальный числовой код: ${n}`;
  codeExplain.textContent=`Сумма кодов выбранных тэттраглифов: ${explainReduction(sum).join(" → ")}`;

  const src=getSourceSyllables(codes);
  renderSyllableLine("srcSyllables",src,[]);

  const {picked,pos,work,repeats}=pickEveryNthSyllable(n,src);
  renderSyllableLine("workSyllables",work,pos);

  workDesc.textContent=repeats
    ? `Рабочая строка удлинена повтором ${repeats} раз(а), чтобы появились позиции ${n} и ${2*n}.`
    : "Рабочая строка (удлинение не потребовалось).";

  pickInfo.textContent=`Выбранные позиции: ${pos.join(", ")} (каждый ${n}-й слог).`;

  nameOut.textContent=`Имя печати: ${picked.join(" ")}`;
  downloadTxtBtn.disabled=false;
}

function resetOutputs(msg){
  codeOut.textContent="";
  codeExplain.textContent="";
  nameOut.textContent="";
  srcSyllables.innerHTML="";
  workSyllables.innerHTML="";
  workDesc.textContent="";
  pickInfo.textContent=msg||"";
  downloadTxtBtn.disabled=true;
}

function showToast(id){
  const t=document.getElementById(id);
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

/* INIT */
renderSelectors();
</script>

</body>
</html>
