<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Калькулятор кода и имени печати</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: sans-serif; max-width: 980px; margin: auto; padding: 20px; }
    select, button, input { font-size: 1em; margin: 6px 0; padding: 6px; }

    .label { font-weight: 700; margin-top: 14px; }
    .muted { color: #555; font-size: 0.95em; }
    .error { color:#b00020; margin-top: 6px; }

    .row { margin: 10px 0 16px; padding: 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; }
    .row-title { font-size: 1.02em; font-weight: 700; }
    .row-desc { color: #555; font-size: 0.95em; margin-top: 6px; }

    .result { margin-top: 16px; font-weight: 700; font-size: 1.1em; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; line-height: 1.7; }

    .syll { display: inline-block; margin-right: 10px; }
    .pick { font-weight: 700; background: #fff3c4; border-radius: 4px; padding: 1px 4px; }

    .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
    .inline { display: inline-flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .toast { font-size: 0.95em; color: #2c6e2f; display: none; }
    .toast.show { display: inline; }

    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #e6e6e6; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { background: #f7f7f7; font-weight: 700; }

    /* Карточки тэттра-частиц (как в stihii-code) */
    .particles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; margin-top: 10px; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fff; }
    .card img { width: 100%; height: auto; border-radius: 8px; display: block; }
    .card .title { font-weight: 700; margin-top: 8px; }
    .card .desc { color: #444; font-size: 0.95em; margin-top: 6px; white-space: pre-line; }
    .card .note { color: #777; font-size: 0.9em; margin-top: 6px; }

    label { margin-right: 6px; }
  </style>
</head>

<body>

  <h2>Калькулятор кода и имени печати</h2>
  <div class="muted" style="margin-top:-6px;">
    Выберите по одному тэттраглифу для каждого врата (минимум 3).
    Суммарный код вычисляется как свёртка суммы кодов выбранных тэттраглифов, после чего имя печати формируется
    через выбор каждого <span class="mono">n</span>-го слога из общей последовательности.
  </div>

  <div class="btn-row inline">
    <label for="numMirrors" class="muted">Количество врат:</label>
    <input id="numMirrors" type="number" min="3" max="60" value="3" style="width:110px;">
    <button onclick="renderSelectors()">Применить</button>
  </div>

  <div id="selectors"></div>

  <!-- Ряд 1: действия -->
  <div class="btn-row inline">
    <button onclick="calculateAll()">Рассчитать код и имя</button>

    <button id="downloadTxtBtn" onclick="downloadResultsTxt()" disabled>Скачать .txt</button>
    <span id="downloadToast" class="toast">Скачано</span>
  </div>

  <!-- Ряд 2: имя практика -->
  <div class="btn-row inline" style="margin-top:6px;">
    <label for="participantName" class="muted">Имя практика:</label>
    <input id="participantName" type="text" placeholder="Введите имя" style="min-width:240px;">
  </div>

  <div id="dupWarn" class="error"></div>

  <div class="label">Сводная таблица по вратам</div>
  <div id="gatesTable"></div>

  <div class="result" id="codeOut"></div>
  <div id="codeExplain" class="muted"></div>

  <div class="result" id="nameOut"></div>

  <div class="label">Исходная строка слогов:</div>
  <div id="srcSyllables" class="mono"></div>

  <div class="label">Рабочая строка:</div>
  <div id="workDesc" class="muted"></div>
  <div id="workSyllables" class="mono"></div>
  <div id="pickInfo" class="muted"></div>

  <div class="label" id="particlesLabel">Тэттрачастицы имени:</div>
  <div id="particlesOut" class="particles-grid"></div>
  <div id="particlesErr" class="muted error"></div>

<script>
/* =========================
   particles.json (в той же папке)
   ========================= */
let particlesMap = {};
fetch("particles.json")
  .then(r => { if (!r.ok) throw new Error(); return r.json(); })
  .then(d => { particlesMap = d; })
  .catch(() => {
    particlesMap = {};
    const el = document.getElementById("particlesErr");
    if (el) el.textContent = "Не удалось загрузить particles.json.";
  });

/* =========================
   DATA: 21 тэттраглиф
   ========================= */
const glyphs = [
  ["Эль Аталар",1,["Ата","Лар"]],
  ["Эль Ви-Шах",2,["Ви","Шах"]],
  ["Эль Нере-Ар",3,["Нере","Ар"]],
  ["Эль Ви-Нар",4,["Ви","Нар"]],
  ["Эль Эн-Инь-О",5,["Эн","Инь","О"]],
  ["Эль Ра-Дам",6,["Ра","Дам"]],
  ["Эль Муд-Рам",7,["Муд","Рам"]],
  ["Эль Мун-Ио",8,["Мун","Ио"]],
  ["Эль Мар-Кам",9,["Мар","Кам"]],
  ["Эль Рэ-Тан",10,["Рэ","Тан"]],
  ["Эль Ке-Тар",11,["Ке","Тар"]],
  ["Эль Ок-Улос",12,["Ок","Улос"]],
  ["Эль Мана-Рат",13,["Мана","Рат"]],
  ["Эль Хот-Та",14,["Хот","Та"]],
  ["Эль Ле-Дар",15,["Ле","Дар"]],
  ["Эль Аму",16,["Эль","Аму"]],
  ["Эль Прай-Я",17,["Прай","Я"]],
  ["Эль Кар",18,["Эль","Кар"]],
  ["Эль Ошта-Лар",19,["Ошта","Лар"]],
  ["Эль Су-Ни-Я",20,["Су","Ни","Я"]],
  ["Эль Ра",21,["Эль","Ра"]],
];

const codeToGlyphName = new Map(glyphs.map(([n,c])=>[c,n]));
const codeToSyllables = new Map(glyphs.map(([n,c,s])=>[c,s]));

/* =========================
   SMALL UTILS
   ========================= */
function uniquePreserveOrder(arr){
  const seen = new Set();
  const out = [];
  for(const x of arr){
    const key = String(x);
    if(!seen.has(key)){
      seen.add(key);
      out.push(x);
    }
  }
  return out;
}

function setParticlesLabel(count){
  const el = document.getElementById("particlesLabel");
  if(!el) return;
  el.textContent = (count === 1) ? "Тэттрачастица имени:" : "Тэттрачастицы имени:";
}

/* =========================
   RENDER SELECTORS (cards)
   ========================= */
function clampMirrors(v){
  v = Number(v);
  return Math.max(3, Math.min(60, Math.floor(v || 3)));
}

function renderSelectors(){
  const total = clampMirrors(numMirrors.value);
  numMirrors.value = total;

  const box = document.getElementById("selectors");
  box.innerHTML = "";

  for(let i=0;i<total;i++){
    const row = document.createElement("div");
    row.className = "row";

    const title = document.createElement("div");
    title.className = "row-title";
    title.textContent = `Врата №${i+1}`;

    const desc = document.createElement("div");
    desc.className = "row-desc";
    desc.textContent = `Выберите тэттраглиф для врат №${i+1}.`;

    const sel = document.createElement("select");
    sel.id = `gate-${i}`;

    const ph = new Option("— выберите тэттраглиф —","",true,true);
    ph.disabled = true;
    sel.add(ph);

    glyphs.forEach(([name,code])=>{
      sel.add(new Option(`${name} (${code})`,code));
    });

    row.append(title,desc,sel);
    box.appendChild(row);
  }

  attachGateHandlers();
  renderGatesTable(Array(total).fill(null));
  resetOutputs("Выберите тэттраглифы и нажмите «Рассчитать код и имя».");
}

/* =========================
   HELPERS
   ========================= */
function reduceCode(sum){
  while(sum>10){
    sum = sum.toString().split("").map(Number).reduce((a,b)=>a+b,0);
  }
  if(sum===1) sum=10;
  return sum;
}

function explainReduction(sum){
  const steps=[];
  let cur=sum;
  while(cur>10){
    const d=cur.toString().split("").map(Number);
    steps.push(`${cur} → ${d.join(" + ")} = ${d.reduce((a,b)=>a+b,0)}`);
    cur=d.reduce((a,b)=>a+b,0);
  }
  if(cur===1){
    steps.push("1 → 10 (по принятому правилу)");
  }
  return steps;
}

function attachGateHandlers(){
  document.querySelectorAll("#selectors select").forEach(sel=>{
    sel.onchange=updateOptionLocks;
  });
  updateOptionLocks();
}

function updateOptionLocks(){
  const selected=[...document.querySelectorAll("#selectors select")]
    .map(s=>s.value).filter(Boolean);

  document.querySelectorAll("#selectors select").forEach(sel=>{
    [...sel.options].forEach(o=>{
      if(!o.value) return;
      o.disabled = selected.includes(o.value) && o.value!==sel.value;
    });
  });
}

function getSourceSyllables(codes){
  return codes.flatMap(c=>codeToSyllables.get(c)||[]);
}

function renderSyllableLine(id,arr,picks){
  document.getElementById(id).innerHTML=arr.map((s,i)=>{
    const n=i+1;
    return `<span class="syll ${picks.includes(n)?"pick":""}">${n}.${s}</span>`;
  }).join(" ");
}

/* =========================
   FIX: имя печати не длиннее n
   - выбираем каждый n-й слог, но не более n раз
   - удлиняем строку ТОЛЬКО если выбрано < 2 слогов
   - если выбрано >=2, но < n — останавливаемся
   ========================= */
function pickEveryNthSyllable(n, src){
  if(!Array.isArray(src) || src.length===0 || !Number.isFinite(n) || n<=0){
    return {picked:[], pos:[], work:[], repeats:0};
  }

  let work = [...src];
  let repeats = 0;

  while(true){
    const k = Math.floor(work.length / n); // сколько позиций n,2n,3n... есть в текущей строке
    const take = Math.min(n, k);           // но не более n слогов по правилу

    const picked = [];
    const pos = [];

    for(let i = 1; i <= take; i++){
      const p = n * i;
      picked.push(work[p-1]);
      pos.push(p);
    }

    // Если уже есть минимум 2 слога — по правилам на этом всё.
    // Даже если picked.length < n (строка короткая), мы НЕ удлиняем.
    if(picked.length >= 2){
      return {picked, pos, work, repeats};
    }

    // Иначе (0 или 1 слог) — удлиняем и пробуем снова
    if(repeats >= 50){
      return {picked, pos, work, repeats};
    }

    work = work.concat(src);
    repeats++;
  }
}

/* =========================
   TABLE
   ========================= */
function renderGatesTable(codes){
  const rows=codes.map((c,i)=>`
    <tr>
      <td><b>Врата №${i+1}</b></td>
      <td>${c?codeToGlyphName.get(c):"—"}</td>
      <td>${c?(codeToSyllables.get(c)||[]).join(", "):"—"}</td>
    </tr>`).join("");

  gatesTable.innerHTML=`
    <table>
      <thead><tr><th>Врата</th><th>Тэттраглиф</th><th>Слоги</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* =========================
   PARTICLES CARDS (dedupe)
   ========================= */
function renderParticlesCards(syllables){
  const box = document.getElementById("particlesOut");
  const err = document.getElementById("particlesErr");
  if(!box) return;

  if(err) err.textContent = "";

  const uniq = uniquePreserveOrder((syllables || []).filter(Boolean));
  setParticlesLabel(uniq.length);

  if(uniq.length === 0){
    box.innerHTML = "";
    return;
  }

  box.innerHTML = uniq.map(s => {
    const p = particlesMap[s];
    return p
      ? `<div class="card">
           ${p.img ? `<img src="${p.img}" alt="${p.title || s}" loading="lazy">` : ""}
           <div class="title">${p.title || s}</div>
           <div class="desc">${p.desc || ""}</div>
         </div>`
      : `<div class="card">
           <div class="title">${s}</div>
           <div class="note">Нет данных</div>
         </div>`;
  }).join("");
}

/* =========================
   TXT EXPORT (dedupe in particles)
   ========================= */
function buildResultsPayload(){
  const nameText = nameOut.textContent.trim();
  if(!nameText || nameText === "Имя печати: —") return null;

  const sealName = nameText.replace("Имя печати:", "").trim() || "печать";
  const practitioner = participantName.value.trim() || "практик";

  const rows = [...document.querySelectorAll("#gatesTable tbody tr")]
    .map(tr => [...tr.children].map(td => td.textContent.trim()));

  const header = ["Врата","Тэттраглиф","Слоги"];
  const tsv = [header, ...rows].map(r => r.join("\t")).join("\n");

  const syllablesRaw = sealName.split(/\s+/).filter(Boolean);
  const syllablesUniq = uniquePreserveOrder(syllablesRaw);

  const particlesLines = syllablesUniq.map(s => {
    const d = particlesMap[s];
    const desc = d?.desc ? d.desc.trim() : "(нет описания)";
    return `${s} → ${desc}`;
  }).join("\n");

  return { practitioner, sealName, nameText, tsv, particlesLines, particlesCount: syllablesUniq.length };
}

function downloadResultsTxt(){
  const p = buildResultsPayload();
  if(!p) return;

  const safe = s => s
    .replace(/\s+/g,"_")
    .replace(/[^A-Za-z0-9_\-\u0400-\u04FF]+/g,"_")
    .replace(/_+/g,"_")
    .replace(/^_+|_+$/g,"");

  const fileName = `${safe(p.practitioner)}-${safe(p.sealName)}.txt`;

  const particlesHeader = (p.particlesCount === 1) ? "Тэттрачастица имени:" : "Тэттрачастицы имени:";

  const content =
`Практик: ${p.practitioner}
${p.nameText}

${p.tsv}

${particlesHeader}
${p.particlesLines}
`;

  const blob = new Blob([content], { type:"text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);

  showToast("downloadToast");
}

/* =========================
   UI HELPERS
   ========================= */
function resetOutputs(msg){
  codeOut.textContent="";
  codeExplain.textContent="";
  nameOut.textContent="";

  srcSyllables.innerHTML="";
  workSyllables.innerHTML="";
  workDesc.textContent="";
  pickInfo.textContent=msg||"";

  const po=document.getElementById("particlesOut");
  const pe=document.getElementById("particlesErr");
  if(po) po.innerHTML="";
  if(pe) pe.textContent="";

  setParticlesLabel(0);

  downloadTxtBtn.disabled=true;
}

function showToast(id){
  const t=document.getElementById(id);
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

/* =========================
   MAIN
   ========================= */
function calculateAll(){
  const selects=[...document.querySelectorAll("#selectors select")];
  const codes=[];

  // дубликаты
  const counts = new Map();

  for(const s of selects){
    if(!s.value){
      document.getElementById("dupWarn").textContent="";
      renderGatesTable(selects.map(x => x.value ? +x.value : null));
      resetOutputs("Выберите тэттраглифы для всех врат.");
      return;
    }
    const v = +s.value;
    codes.push(v);
    const k = String(v);
    counts.set(k, (counts.get(k)||0) + 1);
  }

  for(const [,cnt] of counts){
    if(cnt>1){
      document.getElementById("dupWarn").textContent="Нельзя выбирать одинаковые тэттраглифы для разных врат.";
      renderGatesTable(codes);
      resetOutputs("Обнаружены дубликаты выбора.");
      return;
    }
  }
  document.getElementById("dupWarn").textContent="";

  renderGatesTable(codes);

  const sum = codes.reduce((a,b)=>a+b,0);
  const n = reduceCode(sum);

  codeOut.textContent = `Финальный числовой код: ${n}`;
  codeExplain.textContent = `Сумма кодов выбранных тэттраглифов: ${explainReduction(sum).join(" → ")}`;

  const src = getSourceSyllables(codes);
  renderSyllableLine("srcSyllables", src, []);

  const {picked, pos, work, repeats} = pickEveryNthSyllable(n, src);
  renderSyllableLine("workSyllables", work, pos);

  workDesc.textContent = repeats
    ? `Рабочая строка удлинена повтором исходной строки ${repeats} раз(а), потому что после выбора каждого ${n}-го слога получилось меньше 2 слогов.`
    : "Рабочая строка (удлинение не потребовалось).";

  pickInfo.textContent = `Выбранные позиции: ${pos.join(", ")} (каждый ${n}-й слог).`;

  const sealName = picked.join(" ") || "—";
  nameOut.textContent = `Имя печати: ${sealName}`;

  renderParticlesCards(picked);

  downloadTxtBtn.disabled = (sealName === "—");
}

/* INIT */
renderSelectors();
</script>

</body>
</html>
